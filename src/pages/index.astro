---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import juncmr from '../assets/juncmr.jpeg';
import logoLega from '../assets/logolega.jpg';
import '../styles/index.css';

// √öltima jornada disponible
import lastMatch from '../assets/jornadas/presJ8.png';
// import lastMatch from '../assets/jornadas/presJ7.png';

// i18n
import { getTranslations } from '../i18n/translations';
const t = getTranslations('es').index; // Por defecto espa√±ol, se cambiar√° con JavaScript
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		
		<!-- Hero Section -->
		<section class="hero section--blue">
			<div class="hero-content">
				<div class="hero-text">
					<h1 class="hero-title">
						<span class="emoji-bounce">üèÄ</span>
						<span class="gradient-text" data-i18n="heroTitle">{t.heroTitle}</span>
					</h1>
					<p class="hero-subtitle" data-i18n="heroSubtitle" set:html={t.heroSubtitle}>
					</p>
					<div class="hero-buttons">
						<a href="/jornadas" class="btn btn-primary" data-i18n="btnViewStats">{t.btnViewStats}</a>
						<a href="/jugadas" class="btn btn-secondary" data-i18n="btnViewPlays">{t.btnViewPlays}</a>
					</div>
				</div>
				<div class="hero-image">
					<img src={juncmr.src} alt="Equipo Junior C Masculino" />
					<div class="image-overlay">
						<span class="team-badge" data-i18n="teamBadge">{t.teamBadge}</span>
					</div>
				</div>
			</div>
		</section>

		<!-- Latest Match Section -->
		<section class="latest-match section--white">
			<div class="container">
				<div class="latest-match-content">
					<div class="latest-match-info">
						<div class="match-badge">
							<span class="match-icon" data-i18n="latestMatchBadge" set:html={t.latestMatchBadge}></span>
						</div>
						<h2 class="latest-match-title" data-i18n="latestMatchTitle" set:html={t.latestMatchTitle}>
						</h2>
						<p class="latest-match-description" data-i18n="latestMatchDescription">
							{t.latestMatchDescription}
						</p>
						<div class="match-highlights">
							<div class="highlight-item">
								<span class="highlight-icon" data-i18n="highlightStats">{t.highlightStats}</span>
							</div>
							<div class="highlight-item">
								<span class="highlight-icon" data-i18n="highlightMVP">{t.highlightMVP}</span>
							</div>
						</div>
						<div class="latest-match-actions">
							<a href="/jornadas/jornada8" class="btn btn-primary btn-large" data-i18n="btnViewFullStats">
								{t.btnViewFullStats}
							</a>
						</div>
					</div>
					<div class="latest-match-visual">
						<div class="match-image-container">
							<img src={lastMatch.src} alt="Jornada 8 - Valcude Alcobendas" class="match-preview" />
							<div class="match-overlay">
								<div class="match-result">
									<span class="result-label" data-i18n="matchResultLabel">{t.matchResultLabel}</span>
									<span class="result-date" data-i18n="matchResultDate">{t.matchResultDate}</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Basketball decoration moved outside the content grid -->
				<div class="basketball-decoration-container">
					<div class="basketball-decoration">
						<div class="basketball-icon">üèÄ</div>
						<div class="court-lines"></div>
					</div>
				</div>
			</div>
		</section>

		
		<!-- Stats Preview Section 
		<section class="stats-preview">
			<div class="container">
				<h2 class="section-title" data-i18n="whatYouFindTitle">{t.whatYouFindTitle}</h2>
				<div class="features-grid">
					<div class="feature-card">
						<div class="feature-icon">üìä</div>
						<h3 data-i18n="feature1Title">{t.feature1Title}</h3>
						<p data-i18n="feature1Description">{t.feature1Description}</p>
						<div class="feature-highlight" data-i18n="feature1Highlight">{t.feature1Highlight}</div>
					</div>
					
					<div class="feature-card">
						<div class="feature-icon">üé¨</div>
						<h3 data-i18n="feature2Title">{t.feature2Title}</h3>
						<p data-i18n="feature2Description">{t.feature2Description}</p>
						<div class="feature-highlight" data-i18n="feature2Highlight">{t.feature2Highlight}</div>
					</div>
					
					<div class="feature-card">
						<div class="feature-icon">üì±</div>
						<h3 data-i18n="feature3Title">{t.feature3Title}</h3>
						<p data-i18n="feature3Description">{t.feature3Description}</p>
						<div class="feature-highlight" data-i18n="feature3Highlight">{t.feature3Highlight}</div>
					</div>
				</div>
			</div>
		</section>

		-->

	<!-- Team Info Section -->
	<section class="team-info section--blue">
			<div class="container">
				<div class="team-content">
					<div class="team-text">
						<h2 class="section-title" data-i18n="teamTitle">{t.teamTitle}</h2>
						<p class="team-description" data-i18n="teamDescription" set:html={t.teamDescription}>
						</p>
						<div class="team-stats">
							<div class="stat-item">
								<span class="stat-number">5</span>
								<span class="stat-label" data-i18n="statMatchesWon">{t.statMatchesWon}</span>
							</div>
							<div class="stat-item">
								<span class="stat-number">3</span>
								<span class="stat-label" data-i18n="statMatchesLost">{t.statMatchesLost}</span>
							</div>
							<div class="stat-item">
								<span class="stat-number">6</span>
								<span class="stat-label" data-i18n="statPlays">{t.statPlays}</span>
							</div>
						</div>
					</div>
					<div class="team-logo">
						<img src={logoLega.src} alt="Logo CDE Legan√©s" />
					</div>
				</div>
			</div>
		</section>

		<!-- Quote Section -->
		<section class="quote-section section--white">
			<div class="container">
				<blockquote class="hero-quote">
					<span class="quote-icon">üí≠</span>
					<p data-i18n="quote">{t.quote}</p>
					<cite data-i18n="quoteAuthor">{t.quoteAuthor}</cite>
				</blockquote>
			</div>
		</section>

	<!-- Contact Section -->
	<section class="contact-section team-info section--blue">
			<div class="container">
				<h2 class="section-title" data-i18n="contactTitle">{t.contactTitle}</h2>
				<form id="contactForm" class="contact-form" aria-label="Formulario de contacto">
					<!-- success animation container (hidden until success) -->
					<div class="contact-success" id="contactSuccess" role="status" aria-live="polite">
						<div class="success-card">
							<svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
							<div class="success-text" data-i18n="contactSuccessMessage">{t.contactSuccessMessage}</div>
						</div>
					</div>

					<label>
						<span data-i18n="contactNameLabel">{t.contactNameLabel}</span>
						<input type="text" name="name" required placeholder={t.contactNamePlaceholder} data-i18n-placeholder="contactNamePlaceholder" />
					</label>
					<label>
						<span data-i18n="contactSubjectLabel">{t.contactSubjectLabel}</span>
						<input type="text" name="subject" required placeholder={t.contactSubjectPlaceholder} data-i18n-placeholder="contactSubjectPlaceholder" />
					</label>
					<label>
						<span data-i18n="contactMessageLabel">{t.contactMessageLabel}</span>
						<textarea name="message" rows="6" required placeholder={t.contactMessagePlaceholder} data-i18n-placeholder="contactMessagePlaceholder"></textarea>
					</label>
					<div class="form-actions">
						<button type="submit" class="btn btn-primary" aria-live="polite">
							<span class="btn-text" data-i18n="contactButton">{t.contactButton}</span>
							<span class="btn-spinner" aria-hidden="true"></span>
						</button>
						<span id="contactStatus" role="status" aria-live="polite"></span>
					</div>

					<!-- Hidden localized strings for runtime status messages -->
					<div class="contact-hidden-strings" style="display:none" aria-hidden="true">
						<span id="contactMsgSending" data-i18n="contactSending">{t.contactSending}</span>
						<span id="contactMsgNetworkError" data-i18n="contactNetworkError">{t.contactNetworkError}</span>
						<span id="contactMsgErrorGeneric" data-i18n="contactErrorGeneric">{t.contactErrorGeneric}</span>
					</div>
				</form>
			</div>
		</section>

		<Footer />
		<!-- Trigger server-side visitor cookie on first page load via a hidden request to /api/visitor -->
		<img src="/api/visitor" alt="" aria-hidden="true" style="display:none;width:1px;height:1px;" />
		
		<script>
			import { translations } from '../i18n/translations';
			import type { Language } from '../i18n/translations';
			
			function updatePageLanguage(lang: Language) {
				const t = translations[lang].index;
				
				// Actualizar todos los elementos con data-i18n
				document.querySelectorAll('[data-i18n]').forEach(element => {
					const key = element.getAttribute('data-i18n') as keyof typeof t;
					if (key && t[key]) {
						const translation = t[key] as string;
						
						// Si el elemento tiene set:html, usar innerHTML, sino textContent
						if (element.hasAttribute('data-html') || key.includes('html') || translation.includes('<')) {
							element.innerHTML = translation;
						} else {
							element.textContent = translation;
						}
					}
				});

				// Actualizar placeholders para inputs/textarea que tengan data-i18n-placeholder
				document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
					const key = element.getAttribute('data-i18n-placeholder') as keyof typeof t;
					if (key && t[key]) {
						const translation = t[key] as string;
						try {
							if ((element as HTMLInputElement).placeholder !== undefined) {
								(element as HTMLInputElement).placeholder = translation;
							} else {
								element.setAttribute('placeholder', translation);
							}
						} catch (e) {
							// ignore
						}
					}
				});
			}
			
			function initLanguageSync() {
				// Obtener idioma actual
				const currentLang = (document.documentElement.getAttribute('data-language') || 'es') as Language;
				updatePageLanguage(currentLang);
				
				// Escuchar cambios en el bot√≥n de idioma
				document.addEventListener('click', (e) => {
					const target = e.target as HTMLElement;
					const button = target.closest('.language-toggle-btn');
					
					if (button) {
						// Esperar un momento para que el script del bot√≥n actualice el atributo
						setTimeout(() => {
							const newLang = (document.documentElement.getAttribute('data-language') || 'es') as Language;
							updatePageLanguage(newLang);
						}, 50);
					}
				});
			}
			
			// Inicializar
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initLanguageSync);
			} else {
				initLanguageSync();
			}
			
			// Para navegaci√≥n con Astro
			document.addEventListener('astro:page-load', initLanguageSync);
		</script>

		<script>
			// Contact form submission with improved UI: spinner + success animation
			(function(){
				const form = document.getElementById('contactForm') as HTMLFormElement | null;
				const status = document.getElementById('contactStatus') as HTMLElement | null;
				const getMsg = (id: string, fallback: string) => {
					try { const el = document.getElementById(id); return el ? el.textContent || fallback : fallback; } catch (e) { return fallback; }
				};
				if (!form) return;
				form.addEventListener('submit', async (e) => {
					e.preventDefault();
					const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
					const successEl = document.getElementById('contactSuccess') as HTMLElement | null;
					if (btn) { btn.disabled = true; }
					form.classList.add('is-sending');
					if (status) status.textContent = getMsg('contactMsgSending', 'Enviando...');
					const nameEl = form.elements.namedItem('name') as HTMLInputElement | null;
					const subjectEl = form.elements.namedItem('subject') as HTMLInputElement | null;
					const messageEl = form.elements.namedItem('message') as HTMLTextAreaElement | null;
					const data = {
						name: nameEl?.value.trim() ?? '',
						subject: subjectEl?.value.trim() ?? '',
						message: messageEl?.value.trim() ?? ''
					};

					try {
						console.log('[contact] payload', data);
						const res = await fetch('/api/contact', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
						const text = await res.text();
						console.log('[contact] response-text', text, 'status', res.status);
						let json = null;
						try { if (text) json = JSON.parse(text); } catch (e) { console.warn('[contact] response json parse error', e); }
						if (res.ok) {
							// success UI
							form.reset();
							if (status) status.textContent = '';
							form.classList.remove('is-sending');
							form.classList.remove('is-error');
							form.classList.add('is-success');
							// allow the animation to be visible then remove
							setTimeout(() => { form.classList.remove('is-success'); }, 3800);
						} else {
							const errorMsg = (json && json.error) ? json.error : (text || getMsg('contactMsgErrorGeneric', 'Error al enviar. Intenta de nuevo.'));
							if (status) status.textContent = errorMsg;
							form.classList.add('is-error');
						}
					} catch (err) {
							if (status) status.textContent = getMsg('contactMsgNetworkError', 'Error de red. Intenta otra vez.');
						form.classList.add('is-error');
					} finally {
						if (btn) btn.disabled = false;
						form.classList.remove('is-sending');
						setTimeout(() => { if (status) status.textContent = ''; }, 5000);
					}
				});
			})();
		</script>
	</body>
</html>
